import{f as W,b as ue,q,h as x,j as fe,w as le,g as _,Q as de,x as he,y as ge,z as ne,o as z,v as Y,C as pe,al as me,am as te,c as ve,an as w,G as B,J as ye,D as Se,m as be,ao as ae,ap as Q,ab as _e,aq as ke,ar as Te,as as Ee,A as se,F as ie,at as V,k as Oe,au as we,B as Pe,av as ce,L as Ae,aw as Ne,a4 as O,R as J,s as S}from"./CxzkeP2L.js";function qe(e,n){return n}function Re(e,n,a){for(var g=[],m=n.length,f,u=n.length,h=0;h<m;h++){let v=n[h];ie(v,()=>{if(f){if(f.pending.delete(v),f.done.add(v),f.pending.size===0){var t=e.outrogroups;G(Q(f.done)),t.delete(f),t.size===0&&(e.outrogroups=null)}}else u-=1},!1)}if(u===0){var o=g.length===0&&a!==null;if(o){var l=a,s=l.parentNode;we(s),s.append(l),e.items.clear()}G(n,!o)}else f={pending:new Set(n),done:new Set},(e.outrogroups??(e.outrogroups=new Set)).add(f)}function G(e,n=!0){for(var a=0;a<e.length;a++)Pe(e[a],n)}var oe;function ze(e,n,a,g,m,f=null){var u=e,h=new Map,o=(n&ce)!==0;if(o){var l=e;u=x?q(fe(l)):l.appendChild(W())}x&&le();var s=null,v=de(()=>{var i=a();return _e(i)?i:i==null?[]:Q(i)}),t,d=!0;function p(){r.fallback=s,Ce(r,t,u,n,g),s!==null&&(t.length===0?(s.f&w)===0?se(s):(s.f^=w,M(s,null,u)):ie(s,()=>{s=null}))}var R=ue(()=>{t=_(v);var i=t.length;let C=!1;if(x){var D=he(u)===ge;D!==(i===0)&&(u=ne(),q(u),z(!1),C=!0)}for(var k=new Set,A=ve,I=ye(),y=0;y<i;y+=1){x&&Y.nodeType===pe&&Y.data===me&&(u=Y,C=!0,z(!1));var N=t[y],$=g(N,y),b=d?null:h.get($);b?(b.v&&te(b.v,N),b.i&&te(b.i,y),I&&A.skipped_effects.delete(b.e)):(b=De(h,d?u:oe??(oe=W()),N,$,y,m,n,a),d||(b.e.f|=w),h.set($,b)),k.add($)}if(i===0&&f&&!s&&(d?s=B(()=>f(u)):(s=B(()=>f(oe??(oe=W()))),s.f|=w)),x&&i>0&&q(ne()),!d)if(I){for(const[F,H]of h)k.has(F)||A.skipped_effects.add(H.e);A.oncommit(p),A.ondiscard(()=>{})}else p();C&&z(!0),_(v)}),r={effect:R,items:h,outrogroups:null,fallback:s};d=!1,x&&(u=Y)}function Ce(e,n,a,g,m){var b,F,H,U,X,K,Z,j,ee;var f=(g&Ne)!==0,u=n.length,h=e.items,o=e.effect.first,l,s=null,v,t=[],d=[],p,R,r,i;if(f)for(i=0;i<u;i+=1)p=n[i],R=m(p,i),r=h.get(R).e,(r.f&w)===0&&((F=(b=r.nodes)==null?void 0:b.a)==null||F.measure(),(v??(v=new Set)).add(r));for(i=0;i<u;i+=1){if(p=n[i],R=m(p,i),r=h.get(R).e,e.outrogroups!==null)for(const E of e.outrogroups)E.pending.delete(r),E.done.delete(r);if((r.f&w)!==0)if(r.f^=w,r===o)M(r,null,a);else{var C=s?s.next:o;r===e.effect.last&&(e.effect.last=r.prev),r.prev&&(r.prev.next=r.next),r.next&&(r.next.prev=r.prev),P(e,s,r),P(e,r,C),M(r,C,a),s=r,t=[],d=[],o=s.next;continue}if((r.f&V)!==0&&(se(r),f&&((U=(H=r.nodes)==null?void 0:H.a)==null||U.unfix(),(v??(v=new Set)).delete(r))),r!==o){if(l!==void 0&&l.has(r)){if(t.length<d.length){var D=d[0],k;s=D.prev;var A=t[0],I=t[t.length-1];for(k=0;k<t.length;k+=1)M(t[k],D,a);for(k=0;k<d.length;k+=1)l.delete(d[k]);P(e,A.prev,I.next),P(e,s,A),P(e,I,D),o=D,s=I,i-=1,t=[],d=[]}else l.delete(r),M(r,o,a),P(e,r.prev,r.next),P(e,r,s===null?e.effect.first:s.next),P(e,s,r),s=r;continue}for(t=[],d=[];o!==null&&o!==r;)(l??(l=new Set)).add(o),d.push(o),o=o.next;if(o===null)continue}(r.f&w)===0&&t.push(r),s=r,o=r.next}if(e.outrogroups!==null){for(const E of e.outrogroups)E.pending.size===0&&(G(Q(E.done)),(X=e.outrogroups)==null||X.delete(E));e.outrogroups.size===0&&(e.outrogroups=null)}if(o!==null||l!==void 0){var y=[];if(l!==void 0)for(r of l)(r.f&V)===0&&y.push(r);for(;o!==null;)(o.f&V)===0&&o!==e.fallback&&y.push(o),o=o.next;var N=y.length;if(N>0){var $=(g&ce)!==0&&u===0?a:null;if(f){for(i=0;i<N;i+=1)(Z=(K=y[i].nodes)==null?void 0:K.a)==null||Z.measure();for(i=0;i<N;i+=1)(ee=(j=y[i].nodes)==null?void 0:j.a)==null||ee.fix()}Re(e,y,$)}}f&&Ae(()=>{var E,re;if(v!==void 0)for(r of v)(re=(E=r.nodes)==null?void 0:E.a)==null||re.apply()})}function De(e,n,a,g,m,f,u,h){var o=(u&ke)!==0?(u&Te)===0?be(a,!1,!1):ae(a):null,l=(u&Ee)!==0?ae(m):null;return Se&&o&&(o.trace=()=>{h()[(l==null?void 0:l.v)??m]}),{v:o,i:l,e:B(()=>(f(n,o??a,l??m,h),()=>{e.delete(g)}))}}function M(e,n,a){if(e.nodes)for(var g=e.nodes.start,m=e.nodes.end,f=n&&(n.f&w)===0?n.nodes.start:a;g!==null;){var u=Oe(g);if(f.before(g),g===m)return;g=u}}function P(e,n,a){n===null?e.effect.first=a:n.next=a,a===null?e.effect.last=n:a.prev=n}const Ie="/api";async function c(e,n){const a=await fetch(`${Ie}${e}`,{...n,headers:{"Content-Type":"application/json",...n==null?void 0:n.headers}});if(!a.ok)throw new Error(`HTTP ${a.status}`);return a.json()}async function $e(){return c("/xiaomi")}async function Ve(e){return c(`/xiaomi/${e}/status`)}async function Be(e,n){return c(`/xiaomi/${e}/control`,{method:"POST",body:JSON.stringify(n)})}async function xe(){return c("/roborock/status")}async function Ge(e){return c("/roborock/command",{method:"POST",body:JSON.stringify({cmd:e})})}async function Qe(){return c("/roborock/rooms")}async function Ue(){return c("/roborock/volume")}async function Xe(e){return c("/roborock/volume",{method:"POST",body:JSON.stringify({volume:e})})}async function Ke(e){return c("/roborock/fan-speed",{method:"POST",body:JSON.stringify({mode:e})})}async function Ze(e){return c("/roborock/mop-mode",{method:"POST",body:JSON.stringify({mode:e})})}async function je(e){return c("/roborock/clean-segments",{method:"POST",body:JSON.stringify({segments:e})})}async function er(){return c("/roborock/consumables")}async function rr(e){return c("/roborock/reset-consumable",{method:"POST",body:JSON.stringify({consumable:e})})}async function nr(){return c("/presets")}async function tr(e){return c(`/presets/${e}/apply`,{method:"POST"})}async function Je(){return c("/schedules")}async function ar(e,n,a){return c("/schedules",{method:"POST",body:JSON.stringify({name:e,preset:n,time:a})})}async function or(e){return c(`/schedules/${e}`,{method:"DELETE"})}async function sr(e){return c(`/schedules/${e}/toggle`,{method:"PATCH"})}async function Le(){return c("/pending-actions")}async function ir(){return c("/pending-actions",{method:"DELETE"})}async function Me(e=!1){return c(`/devices${e?"?refresh=true":""}`)}async function Fe(){return c("/yamaha")}async function cr(e){return c(`/yamaha/${e}/status`)}async function ur(e,n){return c(`/yamaha/${e}/control`,{method:"POST",body:JSON.stringify(n)})}async function He(){return c("/purifier/status")}async function fr(e){return c("/purifier/control",{method:"POST",body:JSON.stringify(e)})}let T=null,L=1e3;function Ye(){let e=O(J([])),n=J(new Map),a=O(null),g=O(J([])),m=O(J([])),f=O(J([])),u=O(J([])),h=O(null),o=O(!1),l=null,s=O(!1);function v(){if((T==null?void 0:T.readyState)===WebSocket.OPEN)return;const t=location.protocol==="https:"?"wss:":"ws:";T=new WebSocket(`${t}//${location.host}/ws`),T.onopen=()=>{console.log("WebSocket connected"),S(s,!0),L=1e3},T.onclose=()=>{console.log(`WebSocket disconnected, reconnecting in ${L}ms`),S(s,!1),setTimeout(v,L),L=Math.min(L*2,3e4)},T.onerror=()=>{T==null||T.close()},T.onmessage=d=>{try{const p=JSON.parse(d.data);p.type==="lamp_status"&&p.deviceId&&p.status?n.set(p.deviceId,p.status):p.type==="lamp_offline"&&p.deviceId&&n.delete(p.deviceId)}catch{}}}return{get lamps(){return _(e)},get lampStatuses(){return n},get roborock(){return _(a)},get schedules(){return _(g)},get pendingActions(){return _(m)},get tuyaDevices(){return _(f)},get yamahaDevices(){return _(u)},get airPurifier(){return _(h)},get loading(){return _(o)},get error(){return l},get wsConnected(){return _(s)},initWebSocket(){v()},updateLampStatus(t,d){n.set(t,d)},async refreshLamps(){try{S(e,await $e(),!0);for(const t of _(e))if(t.last_status)try{n.set(t.id,JSON.parse(t.last_status))}catch{}}catch(t){console.error("Failed to fetch lamps:",t)}},async refreshRoborock(){try{S(a,await xe(),!0)}catch{S(a,null)}},async refreshSchedules(){try{S(g,await Je(),!0)}catch(t){console.error("Failed to fetch schedules:",t)}},async refreshPending(){try{S(m,await Le(),!0)}catch(t){console.error("Failed to fetch pending actions:",t)}},async refreshTuya(t=!0){try{S(f,await Me(t),!0)}catch(d){console.error("Failed to fetch Tuya devices:",d)}},async refreshYamaha(){try{S(u,await Fe(),!0)}catch(t){console.error("Failed to fetch Yamaha devices:",t)}},async refreshAirPurifier(){try{S(h,await He(),!0)}catch{S(h,null)}},async refreshAll(){S(o,!0),await Promise.all([this.refreshLamps(),this.refreshRoborock(),this.refreshSchedules(),this.refreshPending(),this.refreshTuya(),this.refreshYamaha(),this.refreshAirPurifier()]),S(o,!1)}}}const lr=Ye();export{tr as a,ir as b,ar as c,or as d,ze as e,Be as f,nr as g,Ve as h,qe as i,Qe as j,Ue as k,er as l,Ge as m,Ke as n,Ze as o,je as p,Xe as q,rr as r,lr as s,sr as t,cr as u,ur as v,fr as w};
